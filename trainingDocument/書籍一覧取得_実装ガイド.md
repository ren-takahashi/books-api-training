# æ›¸ç±ä¸€è¦§å–å¾—API å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## CakePHPçµŒé¨“è€…å‘ã‘ï¼šLaravelå¯¾å¿œè¡¨

| å½¹å‰² | CakePHP | Laravel | é…ç½®å ´æ‰€ |
|------|---------|---------|----------|
| **ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼** | `Controller` | `Controller` | `app/Http/Controllers/` |
| **ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼** | `Request`ã‚¯ãƒ©ã‚¹ | `FormRequest` | `app/Http/Requests/` |
| **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢** | `Response`ã‚¯ãƒ©ã‚¹ | `Resource` | `app/Http/Resources/` |
| **ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯** | `UseCase`ã‚¯ãƒ©ã‚¹ | `Service`ã‚¯ãƒ©ã‚¹ | `app/Services/` |
| **DBæ“ä½œ** | `Table`ã‚¯ãƒ©ã‚¹ | `Model`ï¼ˆEloquentï¼‰ | `app/Models/` |
| **å¤–éƒ¨APIå‘¼ã³å‡ºã—** | `Service`ã‚¯ãƒ©ã‚¹ | `Service`ã‚¯ãƒ©ã‚¹ | `app/Services/` |
| **DIè¨­å®š** | `ServiceProvider` | `ServiceProvider` | `app/Providers/` |

### é‡è¦ãªé•ã„

#### 1. DBæ“ä½œã®é•ã„

**CakePHPï¼ˆTableã‚¯ãƒ©ã‚¹ï¼‰:**
```php
// UsersTable.php
class UsersTable extends Table {
    public function findActive() {
        return $this->find()
            ->where(['status' => 'active'])
            ->toArray();
    }
}
```

**Laravelï¼ˆEloquent Modelï¼‰:**
```php
// User.php (Model)
class User extends Model {
    // ã‚¹ã‚³ãƒ¼ãƒ—ã¨ã—ã¦å®šç¾©
    public function scopeActive($query) {
        return $query->where('status', 'active');
    }
}

// ä½¿ç”¨ä¾‹
User::active()->get();
```

**é‡è¦:** Laravelã§ã¯**ModelãŒç›´æ¥DBã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã†**

#### 2. ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆã®é•ã„

**CakePHPï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆçš„ï¼‰:**
```
Controller â†’ Request â†’ UseCase â†’ Table/Service â†’ Response
```

**Laravelï¼ˆä¸€èˆ¬çš„ãªæ§‹æˆï¼‰:**
```
Controller â†’ (FormRequest) â†’ Service â†’ Model â†’ (Resource)
```

**Laravelï¼ˆã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆï¼‰:** â† **ã¾ãšã¯ã“ã‚Œã‹ã‚‰ï¼**
```
Controller â†’ Model â†’ JSON
```

---

## Laravelã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
app/
â”œâ”€â”€ Http/
â”‚   â”œâ”€â”€ Controllers/            # â˜… ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©ï¼‰
â”‚   â”‚   â””â”€â”€ BookController.php
â”‚   â”œâ”€â”€ Requests/               # â˜… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ï¼ˆPhase 2ã§è¿½åŠ ï¼‰
â”‚   â”‚   â”œâ”€â”€ StoreBookRequest.php
â”‚   â”‚   â””â”€â”€ UpdateBookRequest.php
â”‚   â””â”€â”€ Resources/              # â˜… ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ã‚¯ãƒ©ã‚¹ï¼ˆPhase 2ã§è¿½åŠ ï¼‰
â”‚       â””â”€â”€ BookResource.php
â”œâ”€â”€ Models/                     # â˜… Eloquent Modelï¼ˆDBæ“ä½œï¼‰
â”‚   â””â”€â”€ Book.php
â”œâ”€â”€ Services/                   # â˜… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆPhase 2ã§è¿½åŠ ï¼‰
â”‚   â”œâ”€â”€ BookService.php
â”‚   â””â”€â”€ GoogleBooksService.php
â””â”€â”€ Providers/                  # â˜… DIè¨­å®šï¼ˆPhase 2ã§è¿½åŠ ï¼‰
    â””â”€â”€ AppServiceProvider.php

database/
â””â”€â”€ migrations/                 # â˜… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    â””â”€â”€ 2026_01_14_create_books_table.php

routes/
â””â”€â”€ api.php                     # â˜… APIãƒ«ãƒ¼ãƒˆå®šç¾©
```

---

## å®Ÿè£…ã®æµã‚Œï¼ˆæ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰

### Phase 1: æœ€å°æ§‹æˆã§å‹•ã‹ã™ï¼ˆæ¨å¥¨ï¼šã¾ãšã¯ã“ã“ã‹ã‚‰ï¼ï¼‰

1. âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆãƒ»å®Ÿè¡Œ
2. âœ… Modelä½œæˆ
3. âœ… Controllerä½œæˆï¼ˆindexãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ï¼‰
4. âœ… ãƒ«ãƒ¼ãƒˆå®šç¾©
5. âœ… å‹•ä½œç¢ºèªï¼ˆcurl/Postmanã§ãƒ†ã‚¹ãƒˆï¼‰

**ç›®æ¨™:** `GET /api/books` ã§JSONé…åˆ—ãŒè¿”ã£ã¦ãã‚‹

### Phase 2: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆæ¨å¥¨ï¼šå‹•ã„ã¦ã‹ã‚‰ï¼‰

6. âœ… Serviceã‚¯ãƒ©ã‚¹ã«å‡¦ç†ã‚’ç§»å‹•
7. âœ… FormRequestè¿½åŠ ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ†é›¢ï¼‰
8. âœ… Resourceè¿½åŠ ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ï¼‰

---

## Phase 1: æœ€å°æ§‹æˆã®å®Ÿè£…æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆãƒ»å®Ÿè¡Œ

#### 1-1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œ
docker exec -it books-api sh -c "cd app && php artisan make:migration create_books_table"
```

**ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/database/migrations/2026_01_14_123456_create_books_table.php
```

#### 1-2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:**
```
/home/takahashiren/projects/booksService-training/books-api-training/app/database/migrations/2026_01_14_xxxxxx_create_books_table.php
```

**ç·¨é›†å†…å®¹:**

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('books', function (Blueprint $table) {
            $table->id();                                    // BIGINT PRIMARY KEY
            $table->string('title');                         // VARCHAR(255) NOT NULL
            $table->string('author')->nullable();            // VARCHAR(255) NULL
            $table->string('isbn', 13)->nullable()->unique(); // VARCHAR(13) NULL UNIQUE
            $table->text('cover_image')->nullable();         // TEXT NULL
            $table->text('description')->nullable();         // TEXT NULL
            $table->enum('read_status', ['unread', 'reading', 'completed'])
                  ->default('unread');                       // ENUM DEFAULT 'unread'
            $table->timestamps();                            // created_at, updated_at
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('books');
    }
};
```

**CakePHPã¨ã®é•ã„:**
- CakePHP: `$this->table('books')->addColumn(...)->create();`
- Laravel: `Schema::create('books', function(Blueprint $table) {...});`

#### 1-3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
docker exec -it books-api sh -c "cd app && php artisan migrate"
```

**æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**
```
INFO  Running migrations.

2026_01_14_123456_create_books_table ........................ 42.50ms DONE
```

**ç¢ºèª:**
```bash
# ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
docker exec -it books-db psql -U books_user -d books_app -c "\d books"
```

---

### ã‚¹ãƒ†ãƒƒãƒ—2: Modelä½œæˆ

#### 2-1. Modelãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ

```bash
docker exec -it books-api sh -c "cd app && php artisan make:model Book"
```

**ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/app/Models/Book.php
```

#### 2-2. Modelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:**
```
/home/takahashiren/projects/booksService-training/books-api-training/app/app/Models/Book.php
```

**ç·¨é›†å†…å®¹:**

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Book extends Model
{
    use HasFactory;

    /**
     * The attributes that are mass assignable.
     *
     * @var array<string>
     */
    protected $fillable = [
        'title',
        'author',
        'isbn',
        'cover_image',
        'description',
        'read_status',
    ];

    /**
     * The attributes that should be cast.
     *
     * @var array<string, string>
     */
    protected $casts = [
        'created_at' => 'datetime',
        'updated_at' => 'datetime',
    ];
}
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ:**

1. **`$fillable`**: ä¸€æ‹¬ä»£å…¥å¯èƒ½ãªã‚«ãƒ©ãƒ ã‚’æŒ‡å®š
   - CakePHPã®`$_accessible`ã«ç›¸å½“
   - ã“ã‚Œã‚’è¨­å®šã—ãªã„ã¨`create()`ã‚„`update()`ã§ã‚¨ãƒ©ãƒ¼

2. **`$casts`**: ãƒ‡ãƒ¼ã‚¿å‹ã®å¤‰æ›è¨­å®š
   - `created_at`/`updated_at`ã‚’è‡ªå‹•çš„ã«Carbonã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›

3. **ãƒ†ãƒ¼ãƒ–ãƒ«åã®è‡ªå‹•æ¨æ¸¬**
   - `Book` ãƒ¢ãƒ‡ãƒ« â†’ `books` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè¤‡æ•°å½¢ã«è‡ªå‹•å¤‰æ›ï¼‰
   - æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹å ´åˆ: `protected $table = 'books';`

**CakePHPã¨ã®é•ã„:**

| é …ç›® | CakePHP | Laravel |
|------|---------|---------|
| ã‚¯ãƒ©ã‚¹å | `BooksTable` | `Book` |
| ç¶™æ‰¿å…ƒ | `Table` | `Model` |
| ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾— | `$this->find()->toArray()` | `Book::all()` |
| æ–°è¦ä½œæˆ | `$this->save($entity)` | `Book::create($data)` |

---

### ã‚¹ãƒ†ãƒƒãƒ—3: Controllerä½œæˆ

#### 3-1. Controllerãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ

```bash
docker exec -it books-api sh -c "cd app && php artisan make:controller BookController"
```

**ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/app/Http/Controllers/BookController.php
```

#### 3-2. Controllerãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ï¼ˆindexãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿å®Ÿè£…ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:**
```
/home/takahashiren/projects/booksService-training/books-api-training/app/app/Http/Controllers/BookController.php
```

**ç·¨é›†å†…å®¹:**

```php
<?php

namespace App\Http\Controllers;

use App\Models\Book;
use Illuminate\Http\JsonResponse;

class BookController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function index(): JsonResponse
    {
        // å…¨ä»¶å–å¾—ï¼ˆä½œæˆæ—¥æ™‚ã®é™é †ï¼‰
        $books = Book::orderBy('created_at', 'desc')->get();

        // JSONå½¢å¼ã§è¿”å´
        return response()->json($books);
    }
}
```

**è§£èª¬:**

1. **`Book::orderBy('created_at', 'desc')->get()`**
   - CakePHPã®`$this->Books->find()->order(['created_at' => 'DESC'])->toArray()`ã«ç›¸å½“
   - `get()`ã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—

2. **`response()->json($books)`**
   - é…åˆ—/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•çš„ã«JSONå½¢å¼ã«å¤‰æ›
   - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰200ã‚’è‡ªå‹•è¨­å®š
   - Content-Type: application/json ã‚’è‡ªå‹•è¨­å®š

**CakePHPã¨ã®æ¯”è¼ƒ:**

```php
// CakePHP
public function index()
{
    $books = $this->Books->find()
        ->order(['created_at' => 'DESC'])
        ->toArray();
    
    $this->set('books', $books);
    $this->viewBuilder()->setOption('serialize', ['books']);
}

// Laravel
public function index(): JsonResponse
{
    $books = Book::orderBy('created_at', 'desc')->get();
    return response()->json($books);
}
```

**Laravelã®æ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«ï¼**

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ«ãƒ¼ãƒˆå®šç¾©

#### 4-1. api.phpã‚’ç·¨é›†

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:**
```
/home/takahashiren/projects/booksService-training/books-api-training/app/routes/api.php
```

**ç·¨é›†å†…å®¹:**

```php
<?php

use App\Http\Controllers\BookController;
use Illuminate\Support\Facades\Route;

// æ›¸ç±ä¸€è¦§å–å¾—
Route::get('/books', [BookController::class, 'index']);
```

**è§£èª¬:**

- **`Route::get('/books', [BookController::class, 'index'])`**
  - HTTPãƒ¡ã‚½ãƒƒãƒ‰: GET
  - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `/api/books`ï¼ˆè‡ªå‹•ã§`/api`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒä»˜ãï¼‰
  - å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰: `BookController@index`

**CakePHPã¨ã®é•ã„:**

```php
// CakePHP (config/routes.php)
$routes->scope('/api', function (RouteBuilder $builder) {
    $builder->connect('/books', ['controller' => 'Books', 'action' => 'index']);
});

// Laravel (routes/api.php)
Route::get('/books', [BookController::class, 'index']);
```

**ã‚ˆã‚Šè©³ç´°ãªè¨­å®šï¼ˆå¾Œã§ä½¿ç”¨ï¼‰:**

```php
// RESTful ãƒªã‚½ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒˆã‚’ä¸€æ‹¬å®šç¾©
Route::apiResource('books', BookController::class);

// ä¸Šè¨˜ã¯ä»¥ä¸‹ã¨åŒç­‰
Route::get('/books', [BookController::class, 'index']);        // GET /api/books
Route::post('/books', [BookController::class, 'store']);       // POST /api/books
Route::get('/books/{id}', [BookController::class, 'show']);    // GET /api/books/1
Route::put('/books/{id}', [BookController::class, 'update']);  // PUT /api/books/1
Route::delete('/books/{id}', [BookController::class, 'destroy']); // DELETE /api/books/1
```

---

### ã‚¹ãƒ†ãƒƒãƒ—5: å‹•ä½œç¢ºèª

#### 5-1. ãƒ«ãƒ¼ãƒˆç¢ºèª

```bash
docker exec -it books-api sh -c "cd app && php artisan route:list --path=api/books"
```

**å‡ºåŠ›ä¾‹:**
```
GET|HEAD  api/books ........... books.index â€º BookController@index
```

#### 5-2. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ãƒ†ã‚¹ãƒˆï¼š

```bash
docker exec -it books-db psql -U books_user -d books_app
```

```sql
INSERT INTO books (title, author, isbn, read_status, created_at, updated_at)
VALUES 
  ('ãƒªãƒ¼ãƒ€ãƒ–ãƒ«ã‚³ãƒ¼ãƒ‰', 'Dustin Boswell', '9784873115658', 'reading', NOW(), NOW()),
  ('Clean Code', 'Robert C. Martin', '9780132350884', 'completed', NOW(), NOW()),
  ('The Pragmatic Programmer', 'David Thomas', '9780135957059', 'unread', NOW(), NOW());
```

çµ‚äº†ï¼š
```sql
\q
```

#### 5-3. APIãƒ†ã‚¹ãƒˆï¼ˆcurlï¼‰

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå¤–ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã‹ã‚‰å®Ÿè¡Œ
curl http://localhost:8080/api/books
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
[
  {
    "id": 1,
    "title": "ãƒªãƒ¼ãƒ€ãƒ–ãƒ«ã‚³ãƒ¼ãƒ‰",
    "author": "Dustin Boswell",
    "isbn": "9784873115658",
    "cover_image": null,
    "description": null,
    "read_status": "reading",
    "created_at": "2026-01-14T12:34:56.000000Z",
    "updated_at": "2026-01-14T12:34:56.000000Z"
  },
  {
    "id": 2,
    "title": "Clean Code",
    "author": "Robert C. Martin",
    "isbn": "9780132350884",
    "cover_image": null,
    "description": null,
    "read_status": "completed",
    "created_at": "2026-01-14T12:34:56.000000Z",
    "updated_at": "2026-01-14T12:34:56.000000Z"
  },
  {
    "id": 3,
    "title": "The Pragmatic Programmer",
    "author": "David Thomas",
    "isbn": "9780135957059",
    "cover_image": null,
    "description": null,
    "read_status": "unread",
    "created_at": "2026-01-14T12:34:56.000000Z",
    "updated_at": "2026-01-14T12:34:56.000000Z"
  }
]
```

#### 5-4. APIãƒ†ã‚¹ãƒˆï¼ˆPostmanï¼‰

1. **æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ**
   - Method: `GET`
   - URL: `http://localhost:8080/api/books`

2. **Sendãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯**

3. **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰200ã¨JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª**

---

## âœ… Phase 1 å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆãƒ»å®Ÿè¡Œ
- [ ] `books`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
- [ ] Bookãƒ¢ãƒ‡ãƒ«ãŒä½œæˆã•ã‚ŒãŸ
- [ ] BookControllerãŒä½œæˆã•ã‚ŒãŸ
- [ ] `index`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚ŒãŸ
- [ ] ãƒ«ãƒ¼ãƒˆãŒå®šç¾©ã•ã‚ŒãŸ
- [ ] `curl`ã¾ãŸã¯`Postman`ã§ãƒ†ã‚¹ãƒˆæˆåŠŸ

---

## Phase 2: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

Phase 1ã§å‹•ä½œç¢ºèªãŒã§ããŸã‚‰ã€ä»¥ä¸‹ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—6: Serviceã‚¯ãƒ©ã‚¹ã«å‡¦ç†ã‚’ç§»å‹•

**ç›®çš„:** ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’Controllerã‹ã‚‰åˆ†é›¢

#### 6-1. Serviceã‚¯ãƒ©ã‚¹ä½œæˆ

```bash
docker exec -it books-api sh -c "cd app && mkdir -p app/Services"
```

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:**
```
/home/takahashiren/projects/booksService-training/books-api-training/app/app/Services/BookService.php
```

**BookService.php:**

```php
<?php

namespace App\Services;

use App\Models\Book;
use Illuminate\Database\Eloquent\Collection;

class BookService
{
    /**
     * æ›¸ç±ä¸€è¦§ã‚’å–å¾—
     *
     * @return \Illuminate\Database\Eloquent\Collection
     */
    public function getAllBooks(): Collection
    {
        return Book::orderBy('created_at', 'desc')->get();
    }

    /**
     * IDã§æ›¸ç±ã‚’æ¤œç´¢
     *
     * @param int $id
     * @return \App\Models\Book
     * @throws \Illuminate\Database\Eloquent\ModelNotFoundException
     */
    public function findBookById(int $id): Book
    {
        return Book::findOrFail($id);
    }

    // ä»Šå¾Œè¿½åŠ : create, update, delete
}
```

#### 6-2. Controllerã‚’ä¿®æ­£ï¼ˆServiceã‚’ä½¿ç”¨ï¼‰

```php
<?php

namespace App\Http\Controllers;

use App\Services\BookService;
use Illuminate\Http\JsonResponse;

class BookController extends Controller
{
    /**
     * @param BookService $bookService
     */
    public function __construct(
        private BookService $bookService
    ) {}

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function index(): JsonResponse
    {
        $books = $this->bookService->getAllBooks();
        return response()->json($books);
    }
}
```

**å¤‰æ›´ç‚¹:**
- `Book::orderBy(...)->get()` â†’ `$this->bookService->getAllBooks()`
- ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§`BookService`ã‚’æ³¨å…¥ï¼ˆLaravel ã®DIæ©Ÿèƒ½ï¼‰

**CakePHPã¨ã®å¯¾å¿œ:**

```php
// CakePHP
public function index()
{
    $books = $this->Books->find()
        ->order(['created_at' => 'DESC'])
        ->toArray();
}

// Laravel (ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œ)
public function index(): JsonResponse
{
    $books = $this->bookService->getAllBooks();
    return response()->json($books);
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—7: FormRequestè¿½åŠ ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ†é›¢ï¼‰

**Phase 1ã§ã¯ä¸è¦**ï¼ˆGETã¯å…¥åŠ›ãªã—ï¼‰

å¾Œã®`POST /api/books`ï¼ˆæ›¸ç±ç™»éŒ²ï¼‰ã§å®Ÿè£…ã—ã¾ã™ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—8: Resourceè¿½åŠ ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ï¼‰

**ç›®çš„:** ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’çµ±ä¸€ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

#### 8-1. Resourceã‚¯ãƒ©ã‚¹ä½œæˆ

```bash
docker exec -it books-api sh -c "cd app && php artisan make:resource BookResource"
```

**ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
```
app/app/Http/Resources/BookResource.php
```

#### 8-2. BookResource.phpã‚’ç·¨é›†

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class BookResource extends JsonResource
{
    /**
     * Transform the resource into an array.
     *
     * @return array<string, mixed>
     */
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'title' => $this->title,
            'author' => $this->author,
            'isbn' => $this->isbn,
            'cover_image' => $this->cover_image,
            'description' => $this->description,
            'read_status' => $this->read_status,
            'created_at' => $this->created_at->toISOString(),
            'updated_at' => $this->updated_at->toISOString(),
        ];
    }
}
```

#### 8-3. Controllerã‚’ä¿®æ­£ï¼ˆResourceã‚’ä½¿ç”¨ï¼‰

```php
<?php

namespace App\Http\Controllers;

use App\Http\Resources\BookResource;
use App\Services\BookService;
use Illuminate\Http\JsonResponse;

class BookController extends Controller
{
    public function __construct(
        private BookService $bookService
    ) {}

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Resources\Json\AnonymousResourceCollection
     */
    public function index()
    {
        $books = $this->bookService->getAllBooks();
        return BookResource::collection($books);
    }
}
```

**å¤‰æ›´ç‚¹:**
- `response()->json($books)` â†’ `BookResource::collection($books)`
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’Resourceã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡

---

## ã¾ã¨ã‚

### Phase 1ï¼ˆæœ€å°æ§‹æˆï¼‰ã§å­¦ã‚“ã ã“ã¨

1. âœ… **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†
2. âœ… **Modelï¼ˆEloquentï¼‰**: Laravelã®ORMã€CakePHPã®Tableã«ç›¸å½“
3. âœ… **Controller**: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‡¦ç†ã‚’è¨˜è¿°
4. âœ… **Route**: URLã¨Controllerãƒ¡ã‚½ãƒƒãƒ‰ã®ç´ä»˜ã‘
5. âœ… **JSON API**: `response()->json()`ã§JSONè¿”å´

### Phase 2ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰ã§å­¦ã¶ã“ã¨

6. âœ… **Serviceå±¤**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢
7. âœ… **FormRequest**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ†é›¢
8. âœ… **Resource**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ã®åˆ†é›¢

### CakePHPã¨ã®å¯¾å¿œé–¢ä¿‚ã¾ã¨ã‚

| å½¹å‰² | CakePHP | Laravel |
|------|---------|---------|
| DBæ“ä½œ | `BooksTable::find()` | `Book::orderBy()->get()` |
| ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾— | `$this->Books->get($id)` | `Book::find($id)` |
| æ–°è¦ä½œæˆ | `$this->Books->save($entity)` | `Book::create($data)` |
| JSONè¿”å´ | `$this->set() + serialize` | `response()->json()` |
| ãƒ«ãƒ¼ãƒˆå®šç¾© | `config/routes.php` | `routes/api.php` |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | Requestã‚¯ãƒ©ã‚¹ | FormRequest |

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Phase 1ã‚’å®Œäº†ã•ã›ã‚‹**
   - ä¸Šè¨˜ã®æ‰‹é †ã«å¾“ã£ã¦å®Ÿè£…
   - `GET /api/books`ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

2. **Phase 2ã«é€²ã‚€ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
   - Serviceã‚¯ãƒ©ã‚¹ã§ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
   - ã‚ˆã‚Šä¿å®ˆæ€§ã®é«˜ã„ã‚³ãƒ¼ãƒ‰ã«

3. **æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…**
   - `POST /api/books`ï¼ˆæ›¸ç±ç™»éŒ²ï¼‰
   - `GET /api/books/{id}`ï¼ˆè©³ç´°å–å¾—ï¼‰
   - `PUT /api/books/{id}`ï¼ˆæ›´æ–°ï¼‰
   - `DELETE /api/books/{id}`ï¼ˆå‰Šé™¤ï¼‰

ã¾ãšã¯**Phase 1ã§å‹•ã‹ã™ã“ã¨**ã‚’å„ªå…ˆã—ã¾ã—ã‚‡ã†ï¼ğŸš€
